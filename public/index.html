<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenMind 网关测试台（BYOK）</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0b0f17;
        --card: #121a28;
        --text: #e6e9ef;
        --muted: #9aa4b2;
        --border: #243045;
        --accent: #4f8cff;
        --danger: #ff5c7a;
      }
      @media (prefers-color-scheme: light) {
        :root {
          --bg: #f6f7fb;
          --card: #ffffff;
          --text: #111827;
          --muted: #6b7280;
          --border: #e5e7eb;
          --accent: #2563eb;
          --danger: #e11d48;
        }
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: var(--bg);
        color: var(--text);
      }
      .wrap {
        max-width: 960px;
        margin: 40px auto;
        padding: 0 16px;
      }
      .title {
        font-size: 22px;
        font-weight: 700;
        margin-bottom: 6px;
      }
      .subtitle {
        color: var(--muted);
        margin-bottom: 18px;
        line-height: 1.4;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
      }
      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 6px;
      }
      input,
      textarea,
      select {
        width: 100%;
        box-sizing: border-box;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        background: transparent;
        color: var(--text);
        outline: none;
      }
      textarea {
        min-height: 120px;
        resize: vertical;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 13px;
        line-height: 1.35;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      @media (max-width: 800px) {
        .row {
          grid-template-columns: 1fr;
        }
      }
      .btn {
        background: var(--accent);
        color: white;
        border: 0;
        border-radius: 10px;
        padding: 10px 14px;
        font-weight: 700;
        cursor: pointer;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .warn {
        color: var(--danger);
        font-size: 13px;
        line-height: 1.4;
      }
      pre {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
        line-height: 1.4;
      }
      .hint {
        color: var(--muted);
        font-size: 12px;
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="title">OpenMind 网关测试台（用户自带 API Key / BYOK）</div>
      <div class="subtitle">
        这是给“用户填写自己的 OpenMind API Key”的页面。它会把请求发到本项目的
        <code>/api/dispatch</code>，并以 <code>Authorization: Bearer ...</code>
        方式携带你的 key。<br />
        注意：请只在你信任的域名上输入 key；页面不会持久化保存，但浏览器环境本身无法提供绝对安全保证。
      </div>

      <div class="card">
        <div class="row">
          <div>
            <label>OpenMind API Key（用户自己的）</label>
            <input
              id="apiKey"
              type="password"
              autocomplete="off"
              placeholder="om1_live_..."
            />
            <div class="hint">不会写入服务器存储；仅在本次请求中作为请求头发送。</div>
          </div>
          <div>
            <label>Model（可选）</label>
            <input id="model" placeholder="gpt-4.1-mini" value="gpt-4.1-mini" />
            <div class="hint">如果你的 OpenMind 账户支持其他模型，可自行改。</div>
          </div>
        </div>
      </div>

      <div class="card">
        <label>System Prompt（可选）</label>
        <input
          id="system"
          placeholder="You are a helpful robot."
          value="You are a helpful robot."
        />
        <div style="height: 10px"></div>
        <label>用户输入</label>
        <input id="userText" placeholder="你好！请自我介绍一下。" />
        <div style="height: 12px"></div>
        <button id="sendBtn" class="btn">发送到 /api/dispatch</button>
        <div id="err" class="warn" style="margin-top: 10px; display: none"></div>
      </div>

      <div class="card">
        <label>响应（OpenMind + executor 转发结果）</label>
        <pre id="out">尚未发送请求。</pre>
      </div>

      <div class="card">
        <div class="title" style="font-size: 16px; margin: 0 0 6px 0">
          机器人中文对话面板（连接本地 executor websocket）
        </div>
        <div class="subtitle" style="margin: 0 0 12px 0">
          这里直接连到你本地 executor 的 <code>WS /ws</code>，支持中文指令（转账 + 确认/取消）。
          如果你在 Vercel（https）打开本页面，浏览器会阻止 <code>ws://</code>，请用
          <code>wss://</code>（例如 ngrok 的 wss 地址）。
          <div class="warn" style="margin-top: 8px">
            提醒：不要把 executor 的 /ws 长期暴露给公网；这是调试通道。
          </div>
        </div>

        <label>Executor WebSocket URL</label>
        <input
          id="wsUrl"
          placeholder="wss://xxxx.ngrok-free.app/ws"
          value=""
        />
        <div class="hint">
          本地打开可用：<code>ws://127.0.0.1:8787/ws</code>；Vercel/https 页面请用 wss。
        </div>
        <div style="height: 10px"></div>
        <button id="wsConnectBtn" class="btn">连接</button>
        <button id="wsDisconnectBtn" class="btn" style="background: transparent; border: 1px solid var(--border); color: var(--text); margin-left: 8px">
          断开
        </button>
        <div style="height: 12px"></div>

        <label>对话日志</label>
        <pre id="wsLog">未连接。</pre>
        <div style="height: 12px"></div>

        <label>发送消息（中文指令或普通文本）</label>
        <div class="row">
          <input id="wsMsg" placeholder="例如：转 1.23 USDC 到 0x..." />
          <button id="wsSendBtn" class="btn">发送</button>
        </div>
        <div class="hint">快捷：发送后如收到确认提示，请回复“确认”或“取消”。</div>

        <div style="height: 12px"></div>
        <div class="row">
          <button id="btnConfirm" class="btn">确认</button>
          <button
            id="btnCancel"
            class="btn"
            style="background: transparent; border: 1px solid var(--border); color: var(--text)"
          >
            取消
          </button>
        </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const out = $("out");
      const err = $("err");
      const btn = $("sendBtn");

      const wsLog = $("wsLog");
      const wsUrl = $("wsUrl");
      const wsConnectBtn = $("wsConnectBtn");
      const wsDisconnectBtn = $("wsDisconnectBtn");
      const wsSendBtn = $("wsSendBtn");
      const wsMsg = $("wsMsg");
      const btnConfirm = $("btnConfirm");
      const btnCancel = $("btnCancel");

      let sock = null;

      function setError(message) {
        if (!message) {
          err.style.display = "none";
          err.textContent = "";
          return;
        }
        err.style.display = "block";
        err.textContent = message;
      }

      function logLine(line) {
        const current = wsLog.textContent || "";
        const next = current === "未连接。" ? "" : current;
        wsLog.textContent = (next ? next + "\n" : "") + line;
      }

      function tryDefaultWsUrl() {
        // If running locally (http), default to ws://localhost.
        if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
          return "ws://127.0.0.1:8787/ws";
        }
        // Otherwise leave empty; user should paste wss:// from their tunnel (ngrok/cloudflare).
        return "";
      }

      wsUrl.value = tryDefaultWsUrl();

      function normalizeWsUrl(input) {
        let u = (input || "").trim();
        if (!u) return "";

        // Allow user to paste:
        // - a4dac...ngrok-free.app
        // - https://a4dac...ngrok-free.app
        // - wss://a4dac...ngrok-free.app/ws
        // - ws://127.0.0.1:8787/ws
        if (u.startsWith("http://")) u = "ws://" + u.slice("http://".length);
        if (u.startsWith("https://")) u = "wss://" + u.slice("https://".length);

        const hasScheme = u.startsWith("ws://") || u.startsWith("wss://");
        if (!hasScheme) {
          const local =
            location.hostname === "localhost" || location.hostname === "127.0.0.1";
          u = (local ? "ws://" : "wss://") + u;
        }

        // Ensure it ends with /ws (unless user explicitly provided a path).
        try {
          const parsed = new URL(u);
          if (!parsed.pathname || parsed.pathname === "/") parsed.pathname = "/ws";
          return parsed.toString();
        } catch {
          // Fallback: append /ws if missing
          if (!u.includes("/")) return u + "/ws";
          if (u.endsWith("/")) return u + "ws";
          if (!u.endsWith("/ws")) return u + "/ws";
          return u;
        }
      }

      function connectWs() {
        const url = normalizeWsUrl(wsUrl.value);
        if (!url) {
          logLine("[ui] 请先填写 Executor WebSocket URL（例如 wss://xxxx.ngrok-free.app/ws）。");
          return;
        }
        if (sock) {
          logLine("[ui] 已连接或正在连接，请先断开。");
          return;
        }
        try {
          sock = new WebSocket(url);
        } catch (e) {
          sock = null;
          logLine("[ui] WebSocket 创建失败：" + String(e));
          return;
        }

        logLine("[ui] connecting… " + url);
        sock.onopen = () => logLine("[ws] connected");
        sock.onclose = () => {
          logLine("[ws] closed");
          sock = null;
        };
        sock.onerror = (e) => logLine("[ws] error: " + JSON.stringify(e));
        sock.onmessage = (ev) => {
          const raw = String(ev.data ?? "");
          let obj = null;
          try { obj = JSON.parse(raw); } catch {}
          if (obj && obj.type === "chain_result") {
            // Best-effort link to arcscan if tx_hash exists
            const tx = obj?.result?.data?.tx_hash || obj?.result?.data?.data?.tx_hash;
            logLine("[robot] " + JSON.stringify(obj, null, 2));
            if (tx) logLine("[robot] tx_hash: " + tx + " (打开 testnet.arcscan.app 查询)");
            return;
          }
          logLine("[robot] " + (obj ? JSON.stringify(obj, null, 2) : raw));
        };
      }

      function disconnectWs() {
        if (!sock) {
          logLine("[ui] 未连接。");
          return;
        }
        sock.close();
      }

      function sendWs(text) {
        if (!sock || sock.readyState !== WebSocket.OPEN) {
          logLine("[ui] 未连接 websocket。");
          return;
        }
        sock.send(text);
        logLine("[me] " + text);
      }

      async function send() {
        setError("");
        const apiKey = $("apiKey").value.trim();
        const model = $("model").value.trim() || "gpt-4.1-mini";
        const system = $("system").value.trim() || "You are a helpful robot.";
        const userText = $("userText").value.trim();

        if (!apiKey) return setError("请填写 OpenMind API Key。");
        if (!userText) return setError("请填写用户输入文本。");

        btn.disabled = true;
        btn.textContent = "发送中…";
        out.textContent = "请求中…";

        const payload = {
          openmind: {
            body: {
              model,
              messages: [
                { role: "system", content: system },
                { role: "user", content: userText },
              ],
            },
          },
        };

        try {
          const r = await fetch("/api/dispatch", {
            method: "POST",
            headers: {
              "content-type": "application/json",
              authorization: `Bearer ${apiKey}`,
            },
            body: JSON.stringify(payload),
          });

          const text = await r.text();
          let data;
          try {
            data = JSON.parse(text);
          } catch {
            data = { raw: text };
          }
          out.textContent = JSON.stringify(
            { http_status: r.status, ...data },
            null,
            2
          );
        } catch (e) {
          setError(String(e));
          out.textContent = "请求失败。";
        } finally {
          btn.disabled = false;
          btn.textContent = "发送到 /api/dispatch";
        }
      }

      btn.addEventListener("click", send);
      $("userText").addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") send();
      });

      wsConnectBtn.addEventListener("click", connectWs);
      wsDisconnectBtn.addEventListener("click", disconnectWs);
      wsSendBtn.addEventListener("click", () => sendWs(wsMsg.value.trim()));
      wsMsg.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendWs(wsMsg.value.trim());
      });
      btnConfirm.addEventListener("click", () => sendWs("确认"));
      btnCancel.addEventListener("click", () => sendWs("取消"));
    </script>
  </body>
</html>


